First activate virtual env:

source .venv/bin/activate
cd infrared
source etc/bash_completion.d/infrared

Copy topologies to Infrared:

cp hybrid_undercloud.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp hybrid_controller.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp 3_bridge_1_net.yml ~/infrared/plugins/virsh/vars/topology/network/.

Provision:

infrared virsh -v \
    --topology-nodes hybrid_undercloud:1,hybrid_controller:1 \
    -e override.controller.memory=28672 \
    -e override.undercloud.memory=28672 \
    -e override.controller.cpu=6 \
    -e override.undercloud.cpu=6 \
    --host-address 10.19.110.15 \
    --host-key ~/.ssh/id_rsa \
    --topology-network 3_bridges_1_net

    To clean (and only clean), just add "--cleanup yes"

Install Undercloud:

infrared tripleo-undercloud -v \
 --version=13 \
 --build=latest \
 --images-task=rpm \
 --config-file ~/ir-osp13-sriov/undercloud.conf

Introspect/Tag Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13-sriov/templates \
    --overcloud-script ~/ir-osp13-sriov/overcloud_deploy.sh \
     --build latest --introspect=yes --tagging=yes --deploy=no \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13-sriov/compute.json

CONTAINER STUFF BEFORE DEPLOY (perform as stack on undercloud):

openstack overcloud container image prepare \
--namespace=registry.access.redhat.com/rhosp13 \
--push-destination=192.0.2.1:8787 \
--prefix=openstack- \
--output-env-file=/home/stack/templates/overcloud_images.yaml \
--output-images-file /home/stack/local_registry_images.yaml \
-e /usr/share/openstack-tripleo-heat-templates/environments/neutron-sriov.yaml

openstack overcloud container image upload   --config-file  /home/stack/local_registry_images.yaml   --verbose

OTHER STUFF BEFORE DEPLOY

openstack overcloud roles generate -o /home/stack/templates/roles_data.yaml Controller Compute

openstack flavor create --id auto --ram 6144 --disk 30 --vcpus 4 controller
openstack flavor set --property "cpu_arch"="x86_64" --property "capabilities:boot_option"="local" --property "capabilities:profile"="controller" controller
openstack flavor delete control 

openstack flavor set controller --property "resources:CUSTOM_BAREMETAL"="1"
openstack flavor set controller --property "resources:DISK_GB"="0"
openstack flavor set controller --property "resources:MEMORY_MB"="0"
openstack flavor set controller --property "resources:VCPU"="0"

openstack flavor set compute --property "resources:CUSTOM_BAREMETAL"="1"
openstack flavor set compute --property "resources:DISK_GB"="0"
openstack flavor set compute --property "resources:MEMORY_MB"="0"
openstack flavor set compute --property "resources:VCPU"="0"

ironic node-update <compute(s)> add properties/capabilities='profile:compute,boot_option:local'
ironic node-update <controller(s)> add properties/capabilities='profile:control,boot_option:local'

sudo yum install -y crudini

export SWIFT_PASSWORD=`sudo crudini --get /etc/ironic-inspector/inspector.conf swift password`

mkdir /home/stack/swift-data
cd /home/stack/swift-data

for i in $(openstack baremetal node list | grep -v UUID | awk '{print $2}'); do openstack baremetal introspection data save $i --file data_$i; done
for i in $(openstack baremetal node list | grep -v UUID | awk '{print $2}'); do echo "NODE: $i" ; cat data_$i | jq '.inventory.disks' ; echo "-----" ; done

openstack baremetal node set --property root_device='{"wwn": "<wwn>"}' <compute node>

Deploy Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13-sriov/templates \
    --overcloud-script ~/ir-osp13-sriov/overcloud_deploy.sh \
     --build latest --introspect=no --tagging=no --deploy=yes \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13-sriov/compute.json
