>>> First activate virtual env:

source .venv/bin/activate
cd infrared
source etc/bash_completion.d/infrared

>>> Copy topologies to Infrared:

cp hybrid_undercloud.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp hybrid_controller.yml ~/infrared/plugins/virsh/vars/topology/nodes/.
cp 3_bridges_1_net.yml ~/infrared/plugins/virsh/vars/topology/network/.

>>> Provision:

infrared virsh -v \
    --topology-nodes hybrid_undercloud:1,hybrid_controller:1 \
    -e override.controller.memory=28672 \
    -e override.undercloud.memory=28672 \
    -e override.controller.cpu=6 \
    -e override.undercloud.cpu=6 \
    --host-address 10.19.110.15 \
    --host-key ~/.ssh/id_rsa \
    --topology-network 3_bridges_1_net

    To clean (and only clean), just add "--cleanup yes"

>>> Install Undercloud:

infrared tripleo-undercloud -v \
 --version=13 \
 --build=latest \
 --images-task=rpm \
 --config-file ~/ir-osp13-hci-odl/undercloud.conf

>>> Introspect/Tag Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13-hci-odl/templates \
    --overcloud-script ~/ir-osp13-hci-odl/overcloud_deploy.sh \
     --build latest --introspect=yes --tagging=yes --deploy=no \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13-hci-odl/compute.json

>>> CONTAINER STUFF BEFORE DEPLOY (perform as stack on undercloud):

sudo vi /etc/sysconfig/docker
  INSECURE_REGISTRY="--insecure-registry 192.0.2.3:8787 --insecure-registry 192.0.2.1:8787 --insecure-registry docker-registry.engineering.redhat.com"
sudo systemctl restart docker

openstack overcloud container image prepare \
  --namespace=docker-registry.engineering.redhat.com/rhosp13 \
  --push-destination=192.0.2.1:8787 \
  --prefix=openstack- \
  --tag=latest \
  --output-env-file=/home/stack/templates/overcloud_images.yaml \
  --output-images-file /home/stack/local_registry_images.yaml \
  -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/neutron-opendaylight.yaml

sudo vi /usr/lib/python2.7/site-packages/tripleo_common/image/image_uploader.py
  # DON'T do cleanup after all the uploads so common layers don't get deleted
  # repeatedly
  #self.cleanup(local_images)

  #if DockerImageUploader._images_match(full_image, full_new_repo,
  #                                     insecure_registries):
  #    LOG.info('Skipping upload for image %s' % image_name)
  #    return []

openstack overcloud container image upload   --config-file  /home/stack/local_registry_images.yaml   --verbose

>>> OTHER STUFF BEFORE DEPLOY

sudo yum install -y crudini

export SWIFT_PASSWORD=`sudo crudini --get /etc/ironic-inspector/inspector.conf swift password`

mkdir /home/stack/swift-data
cd /home/stack/swift-data

for i in $(openstack baremetal node list | grep -v UUID | awk '{print $2}'); do openstack baremetal introspection data save $i --file data_$i; done
for i in $(openstack baremetal node list | grep -v UUID | awk '{print $2}'); do echo "NODE: $i" ; cat data_$i | jq '.inventory.disks' ; echo "-----" ; done

openstack baremetal node set --property root_device='{"wwn": "<wwn>"}' <compute node>

sudo yum install -y libguestfs-tools

mkdir images
cd images
for i in /usr/share/rhosp-director-images/overcloud-full-latest-13.0.tar /usr/share/rhosp-director-images/ironic-python-agent-latest-13.0.tar; do tar -xvf $i; done
virt-customize -a overcloud-full.qcow2 --root-password password:redhat
source ~/stackrc
openstack overcloud image upload --update-existing

>>> Deploy Overcloud:

ir tripleo-overcloud -vv --version 13 \
    --deployment-files  ~/ir-osp13-hci-odl/templates \
    --overcloud-script ~/ir-osp13-hci-odl/overcloud_deploy.sh \
     --build latest --introspect=no --tagging=no --deploy=yes \
     -e provison_virsh_network_name=br-ctlplane --hybrid \
     ~/ir-osp13-hci-odl/compute.json
