- Redirect metadata service traffic to vlan 11 device (allows overcloud nodes to call back after initial deployment):

iptables -D INPUT -i br-ctlplane -p udp -m udp --dport 67 -j ironic-inspector
iptables -F ironic-inspector 
iptables -X ironic-inspector 
iptables -t nat -A PREROUTING -d 169.254.169.254/32 -i vlan11 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8775

- Deploy non-DPDK overcloud:

openstack overcloud deploy --templates ~/my_templates/ -e environments/network-isolation.yaml -e ~/my_templates/environments/network-environment.yaml -e ~/my_templates/environments/storage-environment.yaml  --control-scale 1 --compute-scale 1 --compute-flavor compute --control-flavor control --neutron-network-type vxlan --neutron-tunnel-types vxlan --ntp-server 10.5.26.10 -e ~/my_templates/ips-from-pool-all.yaml -e ~/my_templates/post-deployment.yaml

- Set the root_device for all nodes to a particular disk.  In this case, we are setting all nodes' root devices to a disk with a particular (uniform) size across all the hardware:

for node in $(ironic node-list | awk '!/UUID/ {print $2}'); do openstack baremetal node set --property root_device='{"wwn": '$(cat inspector_data-$node | jq '.inventory.disks[] | select(.size==599013720064) | .wwn')'}' $node; done

- Copy overcloudrc to all overcloud nodes:

for i in $(nova list | grep -v ID | awk '{print $12}' | cut -d '=' -f 2); do scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null overcloudrc root@$i:~/.; done

Create SR-IOV networks and ports:

neutron net-create --provider:network_type vlan --provider:physical_network phy-sriov1 --provider:segmentation_id 4071 sriov1
net_id=$(neutron net-list | grep sriov1 | awk '{print $2}')
neutron subnet-create $net_id --allocation_pool start=172.21.0.2,end=172.21.1.0 --name sriov1-sub 172.21.0.0/16
sub_id=$(neutron subnet-list | grep sriov1-sub | awk '{print $2}')
neutron port-create --name sriov1-port --fixed-ip subnet_id=$sub_id,ip_address=172.21.0.10 --vnic-type direct $net_id

neutron net-create --provider:network_type vlan --provider:physical_network phy-sriov2 --provider:segmentation_id 4071 sriov2
net_id=$(neutron net-list | grep sriov2 | awk '{print $2}')
neutron subnet-create $net_id --allocation_pool start=172.22.0.2,end=172.22.1.0 --name sriov2-sub 172.22.0.0/16
sub_id=$(neutron subnet-list | grep sriov2-sub | awk '{print $2}')
neutron port-create --name sriov2-port --fixed-ip subnet_id=$sub_id,ip_address=172.22.0.10 --vnic-type direct $net_id

neutron net-create --provider:network_type vlan --provider:physical_network phy-sriov1 --provider:segmentation_id 4075 sriov-for-bonds
net_id=$(neutron net-list | grep sriov-for-bonds | awk '{print $2}')
neutron subnet-create $net_id --allocation_pool start=172.30.0.2,end=172.30.1.0 --name sriov-for-bonds-sub 172.30.0.0/16
sub_id=$(neutron subnet-list | grep sriov-for-bonds-sub | awk '{print $2}')
neutron port-create --name sriov-bonded-port --fixed-ip subnet_id=$sub_id,ip_address=172.30.0.10 --vnic-type direct $net_id
neutron port-create --name sriov-bonded-port3 --fixed-ip subnet_id=$sub_id,ip_address=172.30.0.12 --vnic-type direct $net_id

neutron net-create --provider:network_type vlan --provider:physical_network phy-sriov2 --provider:segmentation_id 4075 sriov-for-bonds2
net_id=$(neutron net-list | grep sriov-for-bonds2 | awk '{print $2}')
neutron subnet-create $net_id --allocation_pool start=172.30.0.2,end=172.30.1.0 --name sriov-for-bonds-sub2 172.30.0.0/16
sub_id=$(neutron subnet-list | grep sriov-for-bonds-sub2 | awk '{print $2}')
neutron port-create --name sriov-bonded-port2 --fixed-ip subnet_id=$sub_id,ip_address=172.30.0.11 --vnic-type direct $net_id
neutron port-create --name sriov-bonded-port4 --fixed-ip subnet_id=$sub_id,ip_address=172.30.0.13 --vnic-type direct $net_id

Match Ironic nodes to Nova instances:

for node in $(ironic node-list | sort -k3 | awk '!/UUID/ {print $2}'); do echo IRONIC $(ironic node-list | grep $node | awk '{print $4}') ==\> NOVA $(nova list | grep $(ironic node-list | grep $node | awk '{print $6}') | awk '{print $4}'); done

Match IPMI IPs to Nova instances:

for node in $(ironic node-list | sort -k3 | awk '!/UUID/ {print $2}'); do echo $(ironic node-show $node | grep ipmi_address | awk {'print $4'} | cut -d "'" -f 2) ==\> NOVA $(nova list | grep $(ironic node-list | grep $node | awk '{print $6}') | awk '{print $4}'); done
