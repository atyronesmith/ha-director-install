- Redirect metadata service traffic to vlan 11 device (allows overcloud nodes to call back after initial deployment):

iptables -D INPUT -i br-ctlplane -p udp -m udp --dport 67 -j ironic-inspector
iptables -F ironic-inspector 
iptables -X ironic-inspector 
iptables -t nat -A PREROUTING -d 169.254.169.254/32 -i vlan11 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8775

- Deploy non-DPDK overcloud:

openstack overcloud deploy --templates ~/my_templates/ -e environments/network-isolation.yaml -e ~/my_templates/environments/network-environment.yaml -e ~/my_templates/environments/storage-environment.yaml  --control-scale 1 --compute-scale 1 --compute-flavor compute --control-flavor control --neutron-network-type vxlan --neutron-tunnel-types vxlan --ntp-server 10.5.26.10 -e ~/my_templates/ips-from-pool-all.yaml -e ~/my_templates/post-deployment.yaml

- Set the root_device for all nodes to a particular disk.  In this case, we are setting all nodes' root devices to a disk with a particular (uniform) size across all the hardware:

for node in $(ironic node-list | awk '!/UUID/ {print $2}'); do openstack baremetal node set --property root_device='{"wwn": '$(cat inspector_data-$node | jq '.inventory.disks[] | select(.size==599013720064) | .wwn')'}' $node; done

- Copy overcloudrc to all overcloud nodes:

for i in $(nova list | grep -v ID | awk '{print $12}' | cut -d '=' -f 2); do scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null overcloudrc root@$i:~/.; done

Create SR-IOV networks and ports:

neutron net-create --provider:network_type vlan --provider:physical_network phy-sriov1 --provider:segmentation_id 4000 sriov1
net_id=$(neutron net-list | grep sriov1 | awk '{print $2}')
neutron subnet-create $net_id --allocation_pool start=172.20.0.2,end=172.20.1.0 --name sriov1-sub 172.20.0.0/16
sub_id=$(neutron subnet-list | grep sriov1-sub | awk '{print $2}')
neutron port-create --name sriov1-port --fixed-ip subnet_id=$sub_id,ip_address=172.20.0.10 --vnic-type direct $net_id
